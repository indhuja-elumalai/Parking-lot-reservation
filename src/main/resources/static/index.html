<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParkCore: Smart Reservation System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Light gray background */
        }
        .app-container {
            min-height: 90vh;
            max-width: 1200px;
            margin: 2rem auto;
            display: flex;
            background-color: white;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .sidebar {
            width: 280px;
            background-color: #1e3a8a; /* Dark Blue */
            padding: 2rem 1rem;
            color: white;
            flex-shrink: 0;
        }
        .tab-button {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            text-align: left;
            transition: all 0.2s;
            font-weight: 600;
        }
        .tab-button.active {
            background-color: #3b82f6; /* Bright Blue */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .tab-button:not(.active):hover {
            background-color: #374151; /* Darker hover */
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem;
        }
        .input-style {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        .input-style:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                margin: 0.5rem;
                border-radius: 0.75rem;
            }
            .sidebar {
                width: 100%;
                border-radius: 0.75rem 0.75rem 0 0;
                padding: 1rem;
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
            .tab-button {
                flex-grow: 1;
                text-align: center;
                margin: 0.25rem;
            }
            .main-content {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <h2 class="text-2xl font-extrabold mb-6">ParkCore Admin</h2>
            
            <!-- API Base URL Info - Removed Input as it's now relative -->
            <div class="mb-6 p-3 bg-blue-900 rounded-lg text-sm">
                <p class="font-bold mb-1">Status:</p>
                <p>Frontend is served by Spring Boot.</p>
                <p>API Base: `/api/v1` (Relative)</p>
            </div>

            <!-- Navigation Buttons -->
            <nav>
                <button data-tab="book" class="tab-button active bg-blue-600 hover:bg-blue-700 w-full" onclick="switchTab('book')">
                    üöó Book Parking
                </button>
                <button data-tab="manage" class="tab-button hover:bg-blue-800 w-full" onclick="switchTab('manage')">
                    üìù Manage Booking
                </button>
                <button data-tab="admin" class="tab-button hover:bg-blue-800 w-full" onclick="switchTab('admin')">
                    ‚öôÔ∏è Admin Console
                </button>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Dynamic Tab Content -->
            
            <!-- 1. BOOK PARKING TAB -->
            <section id="tab-book" data-tab-content="book">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Find & Book Parking</h1>
                <div class="grid md:grid-cols-2 gap-8">
                    
                    <!-- Availability Check Form -->
                    <div class="bg-white p-6 rounded-xl border border-blue-100 shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-blue-700">1. Select Time</h2>
                        <form id="availabilityForm" onsubmit="checkAvailability(event)" class="space-y-4">
                            <div>
                                <label for="startTime" class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                                <input type="datetime-local" id="startTime" name="startTime" required step="1" class="input-style">
                            </div>
                            <div>
                                <label for="endTime" class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                                <input type="datetime-local" id="endTime" name="endTime" required step="1" class="input-style">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-200">
                                Check Available Slots
                            </button>
                        </form>
                    </div>

                    <!-- Available Slots Display -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-green-700">2. Select Slot</h2>
                        <div id="slot-list" class="grid grid-cols-3 gap-3 min-h-[150px] p-2 bg-gray-50 rounded-lg">
                            <p class="col-span-3 text-center text-gray-500 italic text-sm pt-4">Set your time and check availability.</p>
                        </div>
                    </div>

                    <!-- Reservation Form -->
                    <div id="reservation-card" class="md:col-span-2 bg-white p-6 rounded-xl border border-green-200 shadow-md hidden">
                        <h2 class="text-xl font-semibold mb-4 text-green-700">3. Confirm Details & Book</h2>
                        <form id="reserveForm" onsubmit="makeReservation(event)" class="grid sm:grid-cols-3 gap-4">
                            <input type="hidden" id="selectedSlotId" name="slotId" required>

                            <div>
                                <label for="vehicleNumber" class="block text-sm font-medium text-gray-700 mb-1">Vehicle Number (e.g., KA05MH1234)</label>
                                <input type="text" id="vehicleNumber" name="vehicleNumber" required pattern="[A-Z]{2}\d{2}[A-Z]{2}\d{4}" class="input-style" placeholder="XX00YY0000">
                            </div>

                            <div>
                                <label for="vehicleType" class="block text-sm font-medium text-gray-700 mb-1">Vehicle Type</label>
                                <select id="vehicleType" name="vehicleType" required class="input-style">
                                    <option value="4 wheeler">4 Wheeler (Car, Rs. 30/hr)</option>
                                    <option value="2 wheeler">2 Wheeler (Bike, Rs. 20/hr)</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="sm:col-span-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg self-end transition duration-200">
                                Finalize Booking
                            </button>
                        </form>
                        <p class="mt-4 text-sm font-medium text-gray-600">Selected Slot: <span id="displaySlot" class="font-extrabold text-blue-600">--</span></p>
                    </div>
                </div>
            </section>
            
            <!-- 2. MANAGE BOOKING TAB -->
            <section id="tab-manage" data-tab-content="manage" class="hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Existing Reservation</h1>
                
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-md max-w-lg mx-auto">
                    <h2 class="text-xl font-semibold mb-4 text-blue-700">Lookup or Cancel</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="resId" class="block text-sm font-medium text-gray-700 mb-1">Reservation ID</label>
                            <input type="number" id="resId" required class="input-style" placeholder="Enter Reservation ID (e.g., 1)">
                        </div>
                        <div class="flex space-x-4">
                            <button onclick="handleFetchReservation()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg transition duration-200">
                                GET /reservations/{id}
                            </button>
                            <button onclick="handleDeleteReservation()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition duration-200">
                                DELETE /reservations/{id} (Cancel)
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. ADMIN CONSOLE TAB -->
            <section id="tab-admin" data-tab-content="admin" class="hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Admin Console (Setup)</h1>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Create Floor -->
                    <div class="bg-white p-6 rounded-xl border border-blue-200 shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-blue-700">POST /floors (Create Floor)</h2>
                        <form onsubmit="handleAdminCall(event, 'POST', '/floors', 'floorForm')" id="floorForm" class="space-y-4">
                            <div>
                                <label for="adminFloorName" class="block text-sm font-medium text-gray-700 mb-1">Floor Name</label>
                                <input type="text" id="adminFloorName" name="name" required class="input-style" value="B1 - Main Level">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-200">
                                Create Floor
                            </button>
                        </form>
                    </div>

                    <!-- Create Slots -->
                    <div class="bg-white p-6 rounded-xl border border-green-200 shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-green-700">POST /slots (Create Slots)</h2>
                        <form onsubmit="handleAdminCall(event, 'POST', '/slots', 'slotsForm')" id="slotsForm" class="space-y-4">
                            <div>
                                <label for="adminSlotFloorId" class="block text-sm font-medium text-gray-700 mb-1">Floor ID</label>
                                <input type="number" id="adminSlotFloorId" name="floorId" required class="input-style" value="1">
                            </div>
                            <div>
                                <label for="adminNumSlots" class="block text-sm font-medium text-gray-700 mb-1">Number of Slots</label>
                                <input type="number" id="adminNumSlots" name="numberOfSlots" required class="input-style" value="20">
                            </div>
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-200">
                                Create Slots on Floor
                            </button>
                        </form>
                    </div>
                </div>
            </section>
            
            <!-- Global Status and Response Area -->
            <div class="mt-8 pt-6 border-t border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Transaction Status</h2>
                <div id="status-box" class="p-4 rounded-lg bg-gray-100 text-gray-700 overflow-x-auto text-sm min-h-[50px] font-medium transition duration-200">
                    Welcome to ParkCore. Select a tab to begin.
                </div>
                
                <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-2">Raw API Output</h3>
                <pre id="response-output" class="bg-gray-800 text-green-400 p-4 rounded-lg overflow-x-auto text-xs min-h-[150px] transition duration-200">Awaiting response...</pre>
            </div>

        </main>
    </div>

    <script>
        // *** IMPORTANT CHANGE: BASE_API_PATH is now RELATIVE ***
        const BASE_API_PATH = "/api/v1"; 

        const statusBox = document.getElementById('status-box');
        const responseOutput = document.getElementById('response-output');
        const slotList = document.getElementById('slot-list');
        const reservationCard = document.getElementById('reservation-card');
        
        let selectedSlot = null;
        let reservationTimes = {};

        // --- Core UI Logic ---

        function switchTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'hover:bg-blue-700');
                btn.classList.add('hover:bg-blue-800');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active', 'bg-blue-600', 'hover:bg-blue-700');
                    btn.classList.remove('hover:bg-blue-800');
                }
            });

            // Update sections
            document.querySelectorAll('[data-tab-content]').forEach(section => {
                if (section.id === `tab-${tabName}`) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            });
            // Reset status area
            updateStatus("Navigated to " + tabName.charAt(0).toUpperCase() + tabName.slice(1) + " section.", 'bg-gray-100 text-gray-700');
        }

        function updateStatus(message, classes = 'bg-gray-100 text-gray-700') {
            // Apply status classes and message
            statusBox.className = `p-4 rounded-lg font-medium transition duration-200 ${classes} overflow-x-auto text-sm min-h-[50px]`;
            statusBox.textContent = message;
        }

        // --- Utility Functions ---

        // Formats date-time to the required ISO format (YYYY-MM-DDTHH:MM:SSZ)
        function formatDateTime(localDateTime) {
            if (!localDateTime) return null;
            // The API expects UTC time. We append ':00Z' to force the time provided by the client
            // to be interpreted by the server as a UTC timestamp.
            return localDateTime.substring(0, 16) + ':00Z';
        }

        function toggleLoading(form, isLoading) {
            const button = form.querySelector('button[type="submit"]');
            if (!button) return;
            button.disabled = isLoading;
            button.textContent = isLoading ? 'Processing...' : button.dataset.originalText;
            if (!button.dataset.originalText) {
                 button.dataset.originalText = button.textContent;
            }
        }

        // --- Core API Interaction ---

        async function apiCall(method, path, body = null) {
            // Construct the RELATIVE URL
            const url = BASE_API_PATH + path;
            
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: body ? JSON.stringify(body) : null
            };

            let responseData = null;
            let response = null;

            try {
                responseOutput.textContent = `Sending ${method} request to: ${url}`;
                
                // Exponential backoff mechanism for robustness (max 3 retries)
                for (let i = 0; i < 3; i++) {
                    response = await fetch(url, options);
                    if (response.status !== 429) break; // Not a throttling error, proceed
                    const delay = Math.pow(2, i) * 1000;
                    updateStatus(`Rate limit hit (429). Retrying in ${delay / 1000}s...`, 'bg-yellow-100 text-yellow-800');
                    await new Promise(resolve => setTimeout(resolve, delay));
                }

                const contentType = response.headers.get("content-type");

                if (contentType && contentType.includes("application/json")) {
                    responseData = await response.json();
                } else {
                    responseData = await response.text();
                }

                responseOutput.textContent = JSON.stringify(responseData, null, 2);

                if (!response.ok) {
                    const errorMsg = responseData.message || responseData.error || response.statusText;
                    updateStatus(`API ERROR (${response.status} ${response.statusText}): ${errorMsg}`, 'bg-red-100 text-red-800');
                    return { error: true, status: response.status, data: responseData };
                }

                return { error: false, status: response.status, data: responseData };

            } catch (error) {
                // This catch block usually fires for network errors (DNS, connection refused)
                updateStatus(`NETWORK ERROR: Failed to connect to API. Details: ${error.message}. Since the HTML is served by Spring, check if the server is running.`, 'bg-red-100 text-red-800');
                responseOutput.textContent = `Details: ${error.message}`;
                return { error: true, message: error.message };
            }
        }

        // --- Customer Flow: Booking ---

        async function checkAvailability(event) {
            event.preventDefault();
            const form = event.target;
            toggleLoading(form, true);
            
            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;

            if (!start || !end) {
                updateStatus("Please select both a start and end time.", 'bg-yellow-100 text-yellow-800');
                toggleLoading(form, false);
                return;
            }

            reservationTimes.startTime = formatDateTime(start);
            reservationTimes.endTime = formatDateTime(end);
            
            const path = `/availability?startTime=${reservationTimes.startTime}&endTime=${reservationTimes.endTime}`;

            const result = await apiCall('GET', path);
            toggleLoading(form, false);

            slotList.innerHTML = '';
            selectedSlot = null;
            reservationCard.classList.add('hidden');

            if (result.error) return;

            const availableSlots = result.data;
            if (availableSlots && availableSlots.length > 0) {
                updateStatus(`Found ${availableSlots.length} available slot(s). Select one to proceed to booking.`, 'bg-blue-100 text-blue-800');
                
                availableSlots.forEach(slot => {
                    const slotCard = document.createElement('div');
                    slotCard.className = 'slot-item p-3 border-2 border-gray-300 rounded-lg text-center font-semibold bg-white text-gray-800 hover:bg-green-50 transition duration-150 cursor-pointer';
                    slotCard.textContent = `F${slot.floorId} | S${slot.slotId}`;
                    slotCard.dataset.slotId = slot.slotId;
                    slotCard.dataset.floorId = slot.floorId;
                    
                    slotCard.onclick = () => selectSlot(slot.slotId, slot.floorId, slotCard);
                    slotList.appendChild(slotCard);
                });
            } else {
                slotList.innerHTML = '<p class="col-span-3 text-center text-gray-500 italic text-sm pt-4">No slots available for this period. Try a different time.</p>';
                updateStatus("Sorry, no slots are available for your selected time.", 'bg-yellow-100 text-yellow-800');
            }
        }

        function selectSlot(slotId, floorId, element) {
            selectedSlot = { slotId, floorId };
            
            // Clear previous selections
            document.querySelectorAll('.slot-item').forEach(el => {
                el.classList.remove('border-green-500', 'bg-green-100');
                el.classList.add('border-gray-300', 'bg-white');
            });
            
            // Mark current selection
            element.classList.add('border-green-500', 'bg-green-100');
            element.classList.remove('border-gray-300', 'bg-white');

            // Update reservation form display
            document.getElementById('selectedSlotId').value = slotId;
            document.getElementById('displaySlot').textContent = `Floor ${floorId} - Slot ${slotId}`;
            
            reservationCard.classList.remove('hidden');
            updateStatus(`Slot F${floorId}-S${slotId} selected. Enter vehicle details to finalize booking.`, 'bg-green-100 text-green-800');
            document.getElementById('vehicleNumber').focus();
        }

        async function makeReservation(event) {
            event.preventDefault();
            const form = event.target;
            toggleLoading(form, true);
            
            if (!selectedSlot) {
                updateStatus("Error: Please select a slot first.", 'bg-red-100 text-red-800');
                toggleLoading(form, false);
                return;
            }

            const formData = new FormData(form);
            const requestBody = {
                slotId: Number(formData.get('slotId')),
                vehicleType: formData.get('vehicleType'),
                vehicleNumber: formData.get('vehicleNumber'),
                startTime: reservationTimes.startTime,
                endTime: reservationTimes.endTime
            };

            const result = await apiCall('POST', '/reserve', requestBody);
            toggleLoading(form, false);

            if (!result.error) {
                const data = result.data;
                const cost = data.cost ? `Rs. ${data.cost.toFixed(2)}` : 'Cost calculated by API';
                
                updateStatus(`Booking Successful! ID: ${data.id}. Total Fee: ${cost}. Please save this ID for check-out.`, 'bg-green-500 text-white');
                
                // Reset flow
                selectedSlot = null;
                reservationCard.classList.add('hidden');
                slotList.innerHTML = '<p class="col-span-3 text-center text-gray-500 italic text-sm pt-4">Booking completed. Check availability for next booking.</p>';
            }
        }

        // --- Customer Flow: Management (GET/DELETE) ---

        async function handleFetchReservation() {
            const resId = document.getElementById('resId').value;
            if (!resId) {
                updateStatus("Please enter a Reservation ID to fetch.", 'bg-yellow-100 text-yellow-800');
                return;
            }
            updateStatus(`Fetching reservation ID ${resId}...`, 'bg-blue-100 text-blue-800');
            const result = await apiCall('GET', `/reservations/${resId}`);

            if (!result.error) {
                 updateStatus(`Reservation ${resId} found! Details in Raw API Output.`, 'bg-green-100 text-green-800');
            }
        }

        async function handleDeleteReservation() {
            const resId = document.getElementById('resId').value;
            if (!resId) {
                updateStatus("Please enter a Reservation ID to cancel.", 'bg-yellow-100 text-yellow-800');
                return;
            }

            // Using custom confirmation style instead of window.confirm
            if (!await customConfirm(`Are you sure you want to CANCEL reservation ID ${resId}?`)) {
                 updateStatus("Cancellation aborted by user.", 'bg-gray-100 text-gray-700');
                 return;
            }

            updateStatus(`Attempting to cancel reservation ID ${resId}...`, 'bg-red-100 text-red-800');
            const result = await apiCall('DELETE', `/reservations/${resId}`);

            if (!result.error) {
                 updateStatus(`Reservation ${resId} successfully CANCELLED.`, 'bg-green-500 text-white');
            }
        }

        // Custom modal implementation to replace window.confirm/alert
        function customConfirm(message) {
            return new Promise(resolve => {
                // Create overlay and modal structure
                const modalId = 'custom-confirm-modal';
                let modal = document.getElementById(modalId);
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = modalId;
                    modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 hidden';
                    modal.innerHTML = `
                        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full transform transition-transform duration-300 scale-95">
                            <p id="confirm-message" class="text-lg font-medium text-gray-800 mb-6"></p>
                            <div class="flex justify-end space-x-3">
                                <button id="confirm-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                                <button id="confirm-ok" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Confirm</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }

                document.getElementById('confirm-message').textContent = message;
                modal.classList.remove('hidden');

                const cleanup = (result) => {
                    modal.classList.add('hidden');
                    resolve(result);
                };

                document.getElementById('confirm-ok').onclick = () => cleanup(true);
                document.getElementById('confirm-cancel').onclick = () => cleanup(false);
            });
        }


        // --- Admin Flow: Setup ---

        async function handleAdminCall(event, method, path, formId) {
            event.preventDefault();
            const form = event.target;
            toggleLoading(form, true);
            
            const formData = new FormData(form);
            const requestBody = {};
            
            for (const [key, value] of formData.entries()) {
                if (key === 'floorId' || key === 'numberOfSlots') {
                    requestBody[key] = Number(value);
                } else {
                    requestBody[key] = value;
                }
            }

            const result = await apiCall(method, path, requestBody);
            toggleLoading(form, false);

            if (!result.error) {
                // FIXED: Corrected the termination of the string literal here
                updateStatus(`Admin operation successful: ${path}. Details in Raw API Output.`, 'bg-green-500 text-white');
            }
        }
        
        // --- Initialization ---

        window.onload = function() {
            // Set default times to current time + buffer
            const now = new Date();
            now.setMinutes(now.getMinutes() + 5);
            const startDefault = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            
            now.setHours(now.getHours() + 3);
            const endDefault = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);

            document.getElementById('startTime').value = startDefault;
            document.getElementById('endTime').value = endDefault;
        };

    </script>
</body>
</html>
